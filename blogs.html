<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blogs — Shariar Imtiaz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="bg-indigo-600 text-white">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="index.html" class="bg-white text-indigo-600 px-3 py-1 rounded-lg text-sm font-semibold shadow hover:bg-slate-100">← Home</a>
        <h1 class="text-xl font-bold">Shariar’s Blog</h1>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-10">
    <!-- Filters -->
    <div class="grid md:grid-cols-[1fr,auto,auto] gap-3 items-end mb-6">
      <div>
        <label class="block text-xs text-slate-600 mb-1">Search (title or content)</label>
        <input id="q" type="text" placeholder="e.g., vector search, Oracle 23ai..."
               class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>
      <div>
        <label class="block text-xs text-slate-600 mb-1">From (date)</label>
        <input id="from" type="date"
               class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>
      <div>
        <label class="block text-xs text-slate-600 mb-1">To (date)</label>
        <input id="to" type="date"
               class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
      </div>
    </div>

    <!-- Results summary -->
    <p id="count" class="text-xs text-slate-500 mb-3"></p>

    <!-- Blog list -->
    <div id="blog-list" class="space-y-6"></div>
  </main>

  <footer class="py-10 text-center text-xs text-slate-500">
    © <span id="year"></span> Shariar Imtiaz
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // In-memory index
    let posts = []; // {file, dateStr, date, title, summary, ...}
    let filtered = [];
    let searchVersion = 0;

    // Utility: title from filename if no H1
    function slugToTitle(filename){
      return filename
        .replace(/^\d{4}-\d{2}-\d{2}-/,'')
        .replace(/\.md$/,'')
        .replace(/-/g,' ');
    }

    // Fetch helpers
    async function fetchText(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status} ${url}`);
      return await res.text();
    }

    async function fetchJSON(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status} ${url}`);
      return await res.json();
    }

    function normaliseSummary(text=''){
      return text.replace(/\s+/g,' ').trim();
    }

    // Build index from manifest (no markdown fetch on load)
    async function buildIndex(){
      let manifest = [];
      try {
        manifest = await fetchJSON('./blogs/index.json');
      } catch(e) {
        console.error('Failed to load blogs/index.json', e);
        manifest = [];
      }

      // Sort newest first by filename prefix
      manifest.sort((a,b)=> b.file.localeCompare(a.file));

      posts = manifest.map(item => {
        const file = item.file;
        const fromName = file && file.match(/(\d{4}-\d{2}-\d{2})/);
        const manifestDate = normaliseSummary(item.date || '');
        const dateStr = manifestDate || (fromName ? fromName[1] : '1970-01-01');
        const date = new Date(dateStr);
        const title = normaliseSummary(item.title || slugToTitle(file));
        const summary = normaliseSummary(item.summary || '');

        return {
          file,
          dateStr,
          date,
          title,
          titleLower: title.toLowerCase(),
          summary,
          summaryLower: summary.toLowerCase(),
          content: '',
          contentLoaded: false
        };
      });

      filtered = posts.slice();
      render();
    }

    async function ensureContent(post){
      if(post.contentLoaded){
        return post.content;
      }

      let md = '';
      try {
        md = await fetchText('./blogs/' + post.file);
      } catch(e) {
        console.warn('Failed to fetch post md:', post.file, e);
        post.contentLoaded = true;
        post.content = '';
        return post.content;
      }

      post.content = md.toLowerCase();
      post.contentLoaded = true;

      if(!post.summary){
        const plain = md
          .replace(/```[\s\S]*?```/g, ' ')
          .replace(/`[^`]*`/g, ' ')
          .replace(/\[(.*?)\]\([^)]*\)/g, '$1')
          .replace(/^#.+$/gm, ' ')
          .replace(/[*_>#~-]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
        const truncated = plain.length > 180 ? plain.slice(0, 177).trimEnd() + '…' : plain;
        post.summary = truncated;
        post.summaryLower = post.summary.toLowerCase();
      }

      return post.content;
    }

    function withinRange(post, fromDate, toDate){
      if(fromDate && post.date < fromDate) return false;
      if(toDate && post.date > toDate) return false;
      return true;
    }

    // Apply filters from UI
    async function applyFilters(){
      const version = ++searchVersion;
      const q = document.getElementById('q').value.trim().toLowerCase();
      const fromVal = document.getElementById('from').value;
      const toVal = document.getElementById('to').value;
      const fromDate = fromVal ? new Date(fromVal + 'T00:00:00') : null;
      const toDate = toVal ? new Date(toVal + 'T23:59:59') : null;

      const results = [];
      const needsContent = [];

      posts.forEach(post => {
        if(!withinRange(post, fromDate, toDate)){
          return;
        }

        if(!q){
          results.push(post);
          return;
        }

        if(post.titleLower.includes(q) || (post.summaryLower && post.summaryLower.includes(q))){
          results.push(post);
        }else{
          needsContent.push(post);
        }
      });

      if(q && needsContent.length){
        await Promise.all(needsContent.map(async post => {
          const content = await ensureContent(post);
          if(version !== searchVersion) return;
          if(content && content.includes(q) && withinRange(post, fromDate, toDate)){
            results.push(post);
          }
        }));
      }

      if(version !== searchVersion) return;

      filtered = results;
      render();
    }

    // Render list + count
    function render(){
      const list = document.getElementById('blog-list');
      const count = document.getElementById('count');
      list.innerHTML = '';

      // Sort newest first
      const items = filtered.slice().sort((a,b)=> b.date - a.date);

      count.textContent = `${items.length} post${items.length===1?'':'s'} found`;

      items.forEach(p=>{
        const card = document.createElement('article');
        card.className = "rounded-xl border border-slate-200 bg-white p-6 shadow-sm hover:shadow-md";

        const link = document.createElement('a');
        link.href = `blog.html?file=${encodeURIComponent(p.file)}`;
        link.className = 'block';

        const title = document.createElement('h2');
        title.className = 'text-lg font-bold text-indigo-700';
        title.textContent = p.title;
        link.appendChild(title);

        const meta = document.createElement('p');
        meta.className = 'text-xs text-slate-500';
        meta.textContent = new Date(p.dateStr).toDateString();
        link.appendChild(meta);

        if(p.summary){
          const summary = document.createElement('p');
          summary.className = 'mt-3 text-sm text-slate-600';
          summary.textContent = p.summary;
          link.appendChild(summary);
        }

        card.appendChild(link);
        list.appendChild(card);
      });
    }

    // Wire up filters
    const qInput = document.getElementById('q');
    const fromInput = document.getElementById('from');
    const toInput = document.getElementById('to');

    const triggerFilters = () => { applyFilters().catch(err => console.error(err)); };

    ['input','change'].forEach(ev => {
      qInput.addEventListener(ev, triggerFilters);
      fromInput.addEventListener(ev, triggerFilters);
      toInput.addEventListener(ev, triggerFilters);
    });

    // Init
    buildIndex().then(() => {
      if(qInput.value || fromInput.value || toInput.value){
        triggerFilters();
      }
    }).catch(err => {
      console.error('Failed to build blog index', err);
    });
  </script>
</body>
</html>
